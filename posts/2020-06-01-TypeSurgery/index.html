<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Type Surgery — Daniel Winograd-Cort</title>
    
    <meta name="keywords" content="haskell, row-types, surgery, native">

    <link rel="shortcut icon" type="image/x-icon" href="../../images/haskell-logo.png?format=100w" />  <!-- href="/favicon.ico?format=100w" -->
    <link rel="canonical" href="http://www.danwc.com" />
    <meta property="og:site_name" content="Daniel Winograd‑Cort" />
    <meta property="og:title" content="Type Surgery — Daniel Winograd-Cort" />
    <meta property="og:url" content="https://danwc.com/posts/2020-06-01-TypeSurgery/index.html" />
    <meta property="og:type" content="website" />
    <meta itemprop="name" content="Type Surgery — Daniel Winograd-Cort" />
    <meta itemprop="url" content="https://danwc.com/posts/2020-06-01-TypeSurgery/index.html" />
    <meta name="twitter:title" content="Daniel Winograd‑Cort" />
    <meta name="twitter:url" content="https://danwc.com/posts/2020-06-01-TypeSurgery/index.html" />
    <meta name="twitter:card" content="summary" />
    <meta name="description" content />

    <link rel="stylesheet" href="../../css/default.css" />
  </head>
  <body>
    <header>
      <div class="site-title">
        <h1 class="site-title site-title">
          <a href="../../" title="Daniel Winograd‑Cort">
            <span>Daniel Winograd‑Cort</span>
          </a>
        </h1>
      </div>
      <div class="site-description">
        <p>Senior Software Engineer at Luminous Computing</p>
      </div>

      <nav>
        <a href="../../posts">Posts</a>
        <a href="../../research">Research</a>
        <a href="../../projects">Projects</a>
        <a href="../../teaching">Teaching</a>
        <a href="../../data/danwc-resume.pdf" target="_blank">Resume</a>
        <a href="../../personal">Personal</a>
        <a href="../../contact">Contact</a>
      </nav>
    </header>

    <main role="main">
      <article>
    <section class="header">
        
        Re-posted on June  1, 2020 (originally written April 8, 2019)
        
    </section>
    <section>
        <link rel="stylesheet" href="../../css/syntax.css" />
        <h1 id="type-surgery">Type Surgery</h1>
<p>I read about the idea of “data type surgery” on <a href="https://blog.poisson.chat/posts/2018-11-26-type-surgery.html">Lysxia’s blog post of the same name</a>. I’ll quote from the blog:</p>
<blockquote>
<p>The general motivation is to improve the applicability of various generic definitions, such as aeson’s generic instances for <code>ToJSON</code> and <code>FromJSON</code>. Such a library often offers several options to customize the generic implementations, but it can still happen that none of them quite fit your external requirements and you have to resort to manual implementations, even with only small mismatches with the generic implementations. Surgeries are a new way to adapt generic implementations to such conditions outside of your control.</p>
</blockquote>
<p>As it turns out, one can gain the same powers from the row-types package (something Lysxia hinted at in a footnote in the original blog). Today, I’m going to demonstrate how to use row-types to do type surgery.</p>
<h2 id="example">Example</h2>
<details class="code-details">
<p><summary>Extensions and imports for this Literate Haskell file</summary></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">{-# LANGUAGE AllowAmbiguousTypes #-}</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">{-# LANGUAGE DataKinds #-}</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="ot">{-# LANGUAGE DeriveAnyClass #-}</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="ot">{-# LANGUAGE OverloadedLabels #-}</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ot">{-# LANGUAGE PartialTypeSignatures #-}</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">module</span> <span class="dt">TypeSurgery</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-10" title="10"></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Row.Records</span> <span class="kw">as</span> <span class="dt">Rec</span></a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">import</span> <span class="dt">Data.Aeson</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">import</span> <span class="dt">Data.Coerce</span>            (coerce)</a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw">import</span> <span class="dt">Data.Functor.Identity</span>  (<span class="dt">Identity</span>(..))</a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw">import</span> <span class="dt">GHC.Generics</span></a>
<a class="sourceLine" id="cb1-18" title="18"></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="co">-- Convenient lens functions (rather than importing Lens)</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="ot">over ::</span> ((a <span class="ot">-&gt;</span> <span class="dt">Identity</span> b) <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> <span class="dt">Identity</span> t) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> t</a>
<a class="sourceLine" id="cb1-21" title="21">over <span class="fu">=</span> coerce</a></code></pre></div>
</details>
<p>I’ll use the same example given in Lysxia’s blog:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span> <span class="dt">RecToy</span> <span class="fu">=</span> <span class="dt">RecToy</span></a>
<a class="sourceLine" id="cb2-2" title="2">  {<span class="ot"> iden     ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-3" title="3">  ,<span class="ot"> header1  ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-4" title="4">  ,<span class="ot"> header2  ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb2-5" title="5">  ,<span class="ot"> payload  ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb2-6" title="6">  } <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>, <span class="dt">Generic</span>)</a></code></pre></div>
<p>Here we have a toy record for which we’d like to generate a <code>FromJSON</code> instance, but we have a condition: the <code>payload</code> field is allowed to be optional in the JSON (i.e., a missing field should be parsed as the empty string <code>""</code>). Aeson’s generic instances work fine with optional fields <em>so long as they are <code>Maybe</code> fields</em>, so there seems to be no easy solution. We could make an alternate <code>RecToy'</code> whose <code>payload</code> field is a <code>Maybe String</code> and then convert it, but that’s a lot of boilerplate. We could also write our own <code>FromJSON</code> instance manually, but that’s tedious.</p>
<p>So, let’s do some surgery!</p>
<h2 id="generic-data-surgery">generic-data-surgery</h2>
<p>Lyxsia describes the following solution using the generic-data-surgery library:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">RecToy</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ot">  parseJSON ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">RecToy</span></a>
<a class="sourceLine" id="cb3-3" title="3">  parseJSON</a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="fu">=</span> <span class="fu">fmap</span> ( fromOR</a>
<a class="sourceLine" id="cb3-5" title="5">           <span class="fu">.</span> modifyRField <span class="fu">@</span><span class="st">&quot;payload&quot;</span> defString</a>
<a class="sourceLine" id="cb3-6" title="6">           <span class="fu">.</span> toOR')</a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="fu">.</span> genericParseJSON defaultOptions{omitNothingFields<span class="fu">=</span><span class="dt">True</span>}</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="ot">defString ::</span> <span class="dt">Maybe</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb3-10" title="10">defString <span class="fu">=</span> <span class="fu">maybe</span> <span class="st">&quot;&quot;</span> <span class="fu">id</span></a></code></pre></div>
<p>The key part here is the surgery going on in:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1">fromOR <span class="fu">.</span> modifyRField <span class="fu">@</span><span class="st">&quot;payload&quot;</span> defString <span class="fu">.</span> toOR'</a></code></pre></div>
<p>Let’s break this down:</p>
<ul>
<li><p>First, we head into the “operating room” with <code>toOR'</code>.</p></li>
<li><p>Then, we modify the record field named <code>payload</code> by applying the <code>defString</code> function to it.</p></li>
<li><p>Finally, we exit the “operating room” with <code>fromOR</code>.</p></li>
</ul>
<p>Behind the scenes at the type level, the <code>genericParseJSON</code> is being done on a synthetic type that looks just like <code>RecToy</code> but where the <code>payload</code> field has the type <code>Maybe String</code>. This synthetic type is lifted into the “operating room”, which is essentially lifting it into a manipulatable type and then “operated on”, where the <code>payload</code> field is converted from type <code>Maybe String</code> to <code>String</code> using the <code>defString</code> function. Finally, <code>fromOR</code> converts this manipulatable type to <code>RecToy</code>, and parsing is complete.</p>
<h2 id="row-types-solution">row-types Solution</h2>
<p>For a simple case like this, we can do almost the same thing with row-types. The main difference is that what generic-data-surgery calls an operating room, we simply call a row-types record (or variant). Indeed, instead of going to and from the OR, we can go to and from the native type using <code>Rec.toNative</code> and <code>Rec.fromNative</code>. Specifically:</p>
<ul>
<li><p>Because row-types records are generic themselves, we don’t actually need an operation like <code>toOR'</code>. The result of <code>genericParseJSON</code> will be inferred as the appropriate row-types record directly, and we can start with the expression to modify it.</p></li>
<li><p>In place of <code>modifyRField @"payload" defString</code>, we do a lensy operation to change the record. In this case, we could write <code>over (Rec.focus #payload) defString</code>.</p></li>
<li><p>Finally, we convert back to a Haskell native type with <code>Rec.toNative</code>.</p></li>
</ul>
<p>The full code looks like:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">RecToy</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="ot">  parseJSON ::</span> <span class="dt">Value</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">RecToy</span></a>
<a class="sourceLine" id="cb5-3" title="3">  parseJSON</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="fu">=</span> <span class="fu">fmap</span> ( Rec.toNative</a>
<a class="sourceLine" id="cb5-5" title="5">           <span class="fu">.</span> over (Rec.focus <span class="fu">#</span>payload) defString)</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="fu">.</span> genericParseJSON defaultOptions{omitNothingFields<span class="fu">=</span><span class="dt">True</span>}</a></code></pre></div>
<h2 id="limitations">Limitations</h2>
<p>The row-types library is limited compared to generic-data-surgery in two specific ways: there are no conversion functions between full sum-of-products Haskell data types and variants of records, and there is no support for unnamed fields. The first limitation is simply because such a feature has never seemed necessary to row-types, and it could be added with a little generics programming.</p>
<p>The second is a more fundamental limitation. Names are critical to the concept of the row-types library, as every field in a record and every possibility in a variant must be named. Therefore, it is simply impossible to convert a native record that has no field names into a row-types record (without a lot of defaulting).</p>
    </section>
</article>

    </main>

    <footer>
      <quote>
        <blockquote data-animation-role="quote">
          quotetext
        </blockquote>
        <figcaption class="source">&mdash; quoteattrib</figcaption>
      </quote>
      <p> Site generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    </footer>

  <script>
    var myQs = new Array();
    myQs[0] = "Real stupidity beats artificial intelligence every time. -- Terry Pratchett";
    myQs[1] = "He who wonders discovers that this in itself is wonder. -- M. C. Escher";
    myQs[2] = "Simplicity is the ultimate sophistication. -- Leonardo da Vinci";
    myQs[3] = "Time is like a drug. Too much of it kills you. -- Terry Pratchett";
    myQs[4] = "When it came to getting weird things done, sane beat mad hands down. -- Terry Pratchett";
    myQs[5] = "Students, eh? Love 'em or hate 'em, you're not allowed to hit 'em with a shovel. -- Terry Pratchett";
    myQs[6] = "You get ideas from daydreaming. You get ideas from being bored. You get ideas all the time. -- Neil Gaiman";
    myQs[7] = "I don't know half of you half as well as I should like; and I like less than half of you half as well as you deserve. -- Bilbo Baggins, from J.R.R Tolkien's Lord of the Rings";
    myQs[8] = "Only the insane equate pain with success. -- Cheshire Cat, from American Mcgee's Alice";
    myQs[9] = "Only a few find the way; some don't recognize it when they do; some don't ever want to. -- Cheshire Cat, from American Mcgee's Alice";
    myQs[10] = "Always collect what's useful. Reject only your ignorance, and you may survive. -- Cheshire Cat, from American Mcgee's Alice";
    myQs[11] = "Those who say there's nothing like a nice cup of tea for calming the nerves never had real tea. It's like a syringe of adrenaline straight to the heart! -- Cheshire Cat, from American Mcgee's Alice";
    myQs[12] = "My, Earth really is full of things -- King of All Cosmos, from Katamari Damacy";
    myQs[13] = "The way I see it, if you're going to build a time machine into a car, why not do it with some style? -- Doc, from Back to the Future";
    myQs[14] = "I know because I was there. -- Wadsworth, from Clue";
    myQs[15] = "No meaning yes, or no meaning no? -- Colonel Mustard, from Clue";
    myQs[16] = "I feel like I could... like I could... like I could... TAKE ON THE WORLD!! -- Purple Tentacle, from Day of the Tentacle";
    myQs[17] = "You know what they say: \"If you want to save the world, you have to push a few old ladies down the stairs\". -- Bernard, from Day of the Tentacle";
    myQs[18] = "Wait, I’ve got an idea, and it doesn’t require high explosives. -- Max, from Sam'n'Max Hit the Road";
    myQs[19] = "You have this really convenient subspace highway running through your head that I like to use. It's, like, 3 miles in 15 seconds. -- Ramona, from Scott Pilgrim vs The World";
    myQs[20] = "Do you think that's air you're breathing now?  Stop trying to hit me and hit me! -- Morpheus, from The Matrix";
    myQs[21] = "Ray, when someone asks you if you're a god, you say \"Yes!\" -- Winston, from Ghostbusters";
    myQs[22] = "So, Lone Starr, now you see that evil will always triumph, because good is dumb. -- Dark Helmet, from Spaceballs";
    myQs[23] = "People assume that time is a strict progression of cause to effect, but actually — from a non-linear, non-subjective viewpoint — it's more like a big ball of wibbly-wobbly... timey-wimey... stuff. -- Doctor Who";
    myQs[24] = "I must not fear. Fear is the mind-killer. Fear is the little-death that brings total obliteration. -- Paul Atreides, from Frank Herbert's Dune";
    myQs[25] = "Science fiction writers foresee the inevitable, and although problems and catastrophes may be inevitable, solutions are not. -- Isaac Asimov";
    myQs[26] = "To succeed, planning alone is insufficient. One must improvise as well. -- Isaac Asimov";
    myQs[27] = "Remember - the enemy's gate is down. -- Ender, from Orson Scott Card's Ender's Game";
    myQs[28] = "Space is big. Really big. You just won't believe how vastly, hugely, mindbogglingly big it is. I mean, you may think it's a long way down the road to the chemist's, but that's just peanuts to space. -- Douglas Adams, The Hitchhiker's Guide to the Galaxy";
    myQs[29] = "The chances of finding out what's really going on in the universe are so remote, the only thing to do is hang the sense of it and keep yourself occupied. -- Douglas Adams, The Hitchhiker's Guide to the Galaxy";
    myQs[30] = "Hey, you sass that hoopy Ford Prefect? There's a frood who really knows where his towel is. -- Douglas Adams, The Hitchhiker's Guide to the Galaxy";
    myQs[31] = "There's always money in the banana stand. -- George Bluth, from Arrested Development";
    myQs[32] = "Introducing \"the double decker couch\", so everyone could watch TV together and be buddies! -- Emmet, from The Lego Movie";
    myQs[33] = "Ah! Curse your sudden but inevitable betrayal! -- Wash, from Firefly";
    myQs[34] = "Nothing can happen till you swing the bat. -- Haruko, from FLCL";
    myQs[35] = "Dear God. What is it like in your funny little brains? It must be so boring. -- Sherlock";
    myQs[36] = "You, [subject name here], must be the pride of [subject hometown here]! -- GLaDOS, from Portal";
    myQs[37] = "Please note that we have added a consequence for failure. Any contact with the chamber floor will result in an \"unsatisfactory\" mark on your official testing record, followed by death. Good luck! -- GLaDOS, from Portal";
    myQs[38] = "Did you know you can donate one or all of your vital organs to the Aperture Science Self-Esteem Fund for Girls? It's true! -- GLaDOS, from Portal";
    myQs[39] = "You euthanized your faithful Companion Cube more quickly than any test subject on record. Congratulations. -- GLaDOS, from Portal";
    myQs[40] = "Look at me still talking when there's Science to do -- GLaDOS, from Portal";
    myQs[41] = "The Human Mind: 600 miles of synaptic fiber, five and a half ounces of cranial fluid, 1500 grams of complex neural matter... a three-pound pile of dreams. -- Raz, from Psychonauts";


    var range = myQs.length;
    var index;
    var quote;
    var res;
    var attribution;
    var bodyGrab;

    function getQuote()
    {
      index = Math.floor(Math.random()*range);
      quote = myQs[index];
      res = quote.split(" -- ");
      quote = res[0];
      attribution = res[1];
    }

    var blocks = document.getElementsByTagName("blockquote");
    var captions = document.getElementsByTagName("figcaption");
    for (var i=0;i<blocks.length;i++)
    {
      getQuote();
      bodyGrab = blocks[i].innerHTML;
      bodyGrab = bodyGrab.replace("quotetext", quote);
      blocks[i].innerHTML = bodyGrab;
      bodyGrab = captions[i].innerHTML;
      bodyGrab = bodyGrab.replace("quoteattrib", attribution);
      captions[i].innerHTML = bodyGrab;
    }
  </script>
  </body>
</html>
